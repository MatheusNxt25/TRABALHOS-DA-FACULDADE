--Matheus Oliveira Teodoro RA:2021101509 TADS N10
CREATE DATABASE [bdMatheusOlivieraClinica] --PROVA INSTITUCIONAL - 2
GO

USE [bdMatheusOlivieraClinica]
GO
--Dentista
CREATE TABLE DENTISTA(
CodDentista INT NOT NULL PRIMARY KEY IDENTITY(1,1),
NOME NVARCHAR (50) NOT NULL,
CRO INT NOT NULL UNIQUE,
ESPECIALIDADE NVARCHAR(30) NOT NULL,
TELEFONE NVARCHAR(14) NOT NULL);

--Paciente
CREATE TABLE PACIENTE(
CodPaciente INT NOT NULL PRIMARY KEY IDENTITY(1,1),
NOME NVARCHAR (50) NOT NULL,
SEXO NCHAR(1) CHECK (SEXO IN('M','F')) NOT NULL,
DataNasc DATE NOT NULL,
ENDERECO NVARCHAR(50) NOT NULL,
CIDADE NVARCHAR (30) DEFAULT 'CAMPO GRANDE',
ESTADO NVARCHAR (2) CONSTRAINT PADRAO_ESTADO DEFAULT 'MS',
CPF NVARCHAR (11) NOT NULL UNIQUE,
TELEFONE NVARCHAR (14) NOT NULL);

--Consulta
CREATE TABLE CONSULTA(
CodConsulta INT NOT NULL PRIMARY KEY IDENTITY(1,1),
DATA DATE,
HORA TIME,
CodDentista INT NOT NULL CONSTRAINT FK_CodDentista FOREIGN KEY REFERENCES DENTISTA(CodDentista),
CodPaciente INT NOT NULL CONSTRAINT FK_CodPaciente FOREIGN KEY REFERENCES PACIENTE(CodPaciente),
TRATAMENTO TEXT);

-- índice para a coluna nome do paciente

CREATE NONCLUSTERED INDEX IDXNomePaciente ON PACIENTE (NOME);

--Cadastrar 5 registros em cada tabela

--DENTISTA

--TESTE
INSERT INTO DENTISTA (NOME,CRO,ESPECIALIDADE,TELEFONE) VALUES
('MIGUEL SILVA',3194,'CIRURGIA GERAL','(67)99192-0782');

INSERT INTO DENTISTA (NOME,CRO,ESPECIALIDADE,TELEFONE) VALUES
('HEITOR COSTA',7800,'ORTODONTIA','(67)99193-2087'),
('ARTHUR OLIVEIRA',7690,'RADIOLOGIA','(67)99218-5789'),
('THEO SAMPAIO',7460,'PERIODONTISTA','(67)98416-5798'),
('GAEL DA SILVA',5730,'IMPLANTODONTIA','(67)98414-7898');

-- PACIENTE

--TESTE
INSERT INTO PACIENTE (NOME,SEXO,ENDERECO,DataNasc,CPF,TELEFONE) VALUES
('HELENA OLIVEIRA','F','RUA PRUDENTOPOLIS 1872','25/01/1994','20701006005','(67)95142-1247');

INSERT INTO PACIENTE (NOME,SEXO,ENDERECO,DataNasc,CPF,TELEFONE) VALUES
('LAURA SILVA','F','AV.MUNIZ BARRETO 125','17/05/1999','55764084032','(67)98154-1473'),
('SAMUEL DA SILVA','M','RUA MANOEL DE OLIVEIRA GOMES','15/01/2000','27510664020','(67)99293-0782'),
('LUCAS MATHEUS','M','RUA MARIALVA 174','25/09/1999','58231795022','(67)98165-4554'),
('VICTOR HUGO','M','RUA JOSÉ FALSETTI','10/01/2005','16490313006','(67)98172-2017');

--CONSULTA

--TESTE 

INSERT INTO CONSULTA (DATA,HORA,CodDentista,CodPaciente,TRATAMENTO) VALUES
('21/06/2021','08:00',1,1,'EXTRACAO DE DENTE');

INSERT INTO CONSULTA (DATA,HORA,CodDentista,CodPaciente,TRATAMENTO) VALUES
('22/06/2021','09:00',1,2,'REPARO DE DENTE QUEBRADO'),
('23/06/2021','10:00',2,3,'CHECK-UP'),
('24/06/2021','08:00',3,4,'TIRAR RAIO X'),
('25/06/2021','09:00',5,5,'IMPLANTE DE DENTE QUEBRADO');


--SELECT * FROM DENTISTA
--SELECT * FROM PACIENTE
--SELECT * FROM CONSULTA

--View para apresentar o Nome e o CRO de todos os dentistas cadastrados em ordem alfabética.

CREATE VIEW ConsultaDentista_CRO 
AS SELECT NOME,CRO
FROM DENTISTA; 

SELECT * FROM ConsultaDentista_CRO ORDER BY NOME ASC;

--Stored Procedure que apresente a Data e hora da consulta, o nome do paciente que foi consultado
--e o nome do médico que realizou a consulta

CREATE PROCEDURE DadosPacienteConsulta
AS
BEGIN 
SELECT DATA, HORA, d.NOME, p.NOME
 FROM CONSULTA c
 INNER JOIN DENTISTA d ON d.CodDentista = c.CodDentista
 INNER JOIN PACIENTE p ON p.CodPaciente = c.CodPaciente  
end

EXECUTE DadosPacienteConsulta

--Criar um Stored Procedure que permita consultar um Paciente pelo seu Nome e como resultado apresente
--todos os dados desse Paciente

CREATE PROCEDURE NomePaciente
@CampoBuscar VARCHAR(30)
AS
BEGIN
SELECT NOME,SEXO,DataNasc,ENDERECO,CIDADE,ESTADO,CPF,TELEFONE
FROM PACIENTE
WHERE NOME = @CampoBuscar
END;

--EXEMPLO (EXECUTE NomePaciente 'Nome';)
EXECUTE NomePaciente 'HELENA OLIVEIRA';

--Altere o endereço do primeiro paciente que você cadastrou para: Rua das Flores, 525

CREATE TRIGGER Tr_ConfirmaAlteracao
ON PACIENTE FOR UPDATE
AS
BEGIN
IF(SELECT COUNT (*) FROM deleted) <> 0
PRINT 'DADOS DO CLIENTE ALTERADOS COM SUCESSO!'
END;

--TESTE
UPDATE PACIENTE SET ENDERECO = 'Rua das Flores, 525'
WHERE CodPaciente = 1

--SELECT * FROM PACIENTE

--Apague a segunda consulta que você cadastrou

CREATE TRIGGER TR_ConfirmaExclusao
on CONSULTA FOR DELETE
AS
BEGIN
IF (SELECT COUNT (*) FROM deleted) <> 0
PRINT 'CONSULTA EXCLUIDA COM SUCESSO!'
END;

--TESTE
DELETE FROM CONSULTA WHERE CodConsulta = 2;

--SELECT * FROM CONSULTA





















